<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Noto Sans JP', sans-serif;
      display: flex; height: 100vh; overflow: hidden; background: #f8f9fa;
    }
    #sidebar {
      width: 280px; min-width: 280px; height: 100vh; background: #1a1a2e;
      color: #e0e0e0; display: flex; flex-direction: column;
      border-right: 1px solid #16213e; overflow: hidden;
    }
    #sidebar-header {
      padding: 16px 20px; font-size: 14px; font-weight: 600; color: #a0a0c0;
      border-bottom: 1px solid #16213e; letter-spacing: 0.5px; flex-shrink: 0;
    }
    #search-box { padding: 12px 16px; flex-shrink: 0; }
    #search-input {
      width: 100%; padding: 8px 12px; border: 1px solid #2a2a4a;
      border-radius: 6px; background: #16213e; color: #e0e0e0;
      font-size: 13px; outline: none; transition: border-color 0.2s;
    }
    #search-input:focus { border-color: #5c6bc0; }
    #search-input::placeholder { color: #666; }
    #file-tree { flex: 1; overflow-y: auto; padding: 8px 0; }
    #file-tree::-webkit-scrollbar { width: 6px; }
    #file-tree::-webkit-scrollbar-track { background: transparent; }
    #file-tree::-webkit-scrollbar-thumb { background: #2a2a4a; border-radius: 3px; }
    .tree-item {
      display: flex; align-items: center; padding: 7px 16px; cursor: pointer;
      font-size: 13px; line-height: 1.4; transition: background 0.15s;
      user-select: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .tree-item:hover { background: #16213e; }
    .tree-item.active { background: #1e3a5f; color: #fff; font-weight: 500; }
    .tree-item .icon { margin-right: 8px; font-size: 14px; flex-shrink: 0; width: 18px; text-align: center; }
    .tree-item .label { overflow: hidden; text-overflow: ellipsis; }
    .folder-children { overflow: hidden; transition: max-height 0.25s ease; }
    .folder-children.collapsed { max-height: 0 !important; }
    .depth-1 { padding-left: 32px; }
    .depth-2 { padding-left: 48px; }
    .depth-3 { padding-left: 64px; }
    .depth-4 { padding-left: 80px; }
    .depth-5 { padding-left: 96px; }
#main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    #content-frame { flex: 1; width: 100%; border: none; background: #fff; }
    #placeholder {
      flex: 1; display: flex; align-items: center; justify-content: center;
      color: #999; font-size: 15px; background: #fff;
    }
    #loading {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(26, 26, 46, 0.7); z-index: 100; align-items: center;
      justify-content: center; color: #fff; font-size: 14px;
    }
    #loading.show { display: flex; }
    .spinner {
      width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #5c6bc0; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-right: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 768px) { #sidebar { width: 220px; min-width: 220px; } }
  </style>
</head>
<body>
  <div id="loading"><div class="spinner"></div><span>Ë™≠„ÅøËæº„Åø‰∏≠...</span></div>
  <div id="sidebar">
    <div id="sidebar-header">üìÅ „Éâ„Ç≠„É•„É°„É≥„Éà‰∏ÄË¶ß</div>
    <div id="search-box"><input type="text" id="search-input" placeholder="„Éï„Ç°„Ç§„É´Âêç„ÅßÊ§úÁ¥¢..."></div>
    <div id="file-tree"></div>
  </div>
  <div id="main">
    <div id="placeholder">‚Üê Â∑¶„ÅÆ„É™„Çπ„Éà„Åã„Çâ„Éâ„Ç≠„É•„É°„É≥„Éà„ÇíÈÅ∏„Çì„Åß„Å≠</div>
    <iframe id="content-frame" style="display:none;"></iframe>
  </div>
  <script>
    let treeData = [];
    let activeItem = null;
    (function init() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(data) { treeData = data; renderTree(data); showLoading(false); })
        .withFailureHandler(function(err) { showLoading(false); document.getElementById('file-tree').innerHTML = '<div style="padding:16px;color:#e57373;">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + err.message + '</div>'; })
        .getDocumentTree();
    })();
    function renderTree(nodes, container, depth) {
      depth = depth || 0;
      container = container || document.getElementById('file-tree');
      container.innerHTML = '';
      nodes.forEach(function(node) { node.type === 'folder' ? renderFolder(node, container, depth) : renderFile(node, container, depth); });
    }
    function renderFolder(node, container, depth) {
      var item = document.createElement('div');
      item.className = 'tree-item depth-' + depth;
      item.innerHTML = '<span class="icon">‚ñº</span><span class="label">' + escapeHtml(node.name) + '</span>';
      var children = document.createElement('div');
      children.className = 'folder-children';
      item.addEventListener('click', function() { var c = children.classList.toggle('collapsed'); item.querySelector('.icon').textContent = c ? '‚ñ∂' : '‚ñº'; });
      container.appendChild(item);
      container.appendChild(children);
      if (node.children && node.children.length > 0) {
        node.children.forEach(function(child) { child.type === 'folder' ? renderFolder(child, children, depth + 1) : renderFile(child, children, depth + 1); });
        children.style.maxHeight = children.scrollHeight + 'px';
      }
    }
    var FILE_ICONS = { doc: 'üìÑ', sheet: 'üìä', slide: 'üìë', pdf: 'üìï' };
    function selectFile(item, url) {
      if (activeItem) activeItem.classList.remove('active');
      item.classList.add('active'); activeItem = item;
      var frame = document.getElementById('content-frame');
      document.getElementById('placeholder').style.display = 'none';
      frame.style.display = 'block'; frame.src = url;
    }
    function renderFile(node, container, depth) {
      var icon = FILE_ICONS[node.fileType] || 'üìÑ';
      var item = document.createElement('div');
      item.className = 'tree-item depth-' + depth;
      item.dataset.url = node.url;
      item.dataset.name = node.name;
      item.innerHTML = '<span class="icon">' + icon + '</span><span class="label">' + escapeHtml(node.name) + '</span>';
      item.addEventListener('click', function() { selectFile(item, node.url); });
      container.appendChild(item);
    }
    document.getElementById('search-input').addEventListener('input', function(e) {
      var q = e.target.value.toLowerCase().trim();
      if (!q) { renderTree(treeData); return; }
      renderTree(filterTree(treeData, q));
    });
    function filterTree(nodes, query) {
      var result = [];
      nodes.forEach(function(node) {
        if (node.type === 'folder') { var fc = filterTree(node.children || [], query); if (fc.length > 0) result.push({ type: 'folder', name: node.name, children: fc }); }
        else { if (node.name.toLowerCase().indexOf(query) !== -1) result.push(node); }
      });
      return result;
    }
    function escapeHtml(str) { var d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
    function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); }
  </script>
</body>
</html>
